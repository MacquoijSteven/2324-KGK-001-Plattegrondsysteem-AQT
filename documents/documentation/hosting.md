# Setting up custom hosting

[Back to index](../../README.md)

## Table of Contents
 - [Prerequisites](#prerequisites)  
 - [Installing PHP](#php)  
 - [Installing MySQL](#mysql)  
 - [Editing .env](#env)  
 - [Setting up application](#application)  
 - [Setting up Git Update](#scripts)  
 - [Finishing up](#finished)  

## Prerequisites
An up-to-date ubuntu server (in this installation version 22.04 was used) or VM with a static IP address and a domain name pointing to it, or a hosting service with a domain name pointing to it (our setup at the time of writing also worked on combell).

## PHP
### Installing Nginx
To install PHP on Nginx, you must first install Nginx, which you can achieve through a simple apt-get install command:
```bash
sudo apt-get install nginx
```
After installing Nginx, you can verify that it is running by checking the status:
```bash
sudo systemctl status nginx
```

### Installing PHP-FPM
As Nginx does not have native support for PHP, you must install PHP-FPM, which is a PHP FastCGI implementation. As this application is not included in the default apt repositories, you must add the ondrej/php repository:
```bash
sudo add-apt-repository ppa:ondrej/php
```
After adding the repository and running `apt update`, you can install PHP-FPM:
```bash
sudo apt-get install php8.2-fpm
```
And just like with Nginx you can verify that it is running by checking the status:
```bash
sudo systemctl status php8.2-fpm
```

### Configuring Nginx
To configure Nginx to use PHP-FPM, you must edit the default Nginx configuration file to use the newly installed PHP-FPM module. You can open the configuration file in the text editor of your choice, but for this example we will use nano:
```bash
sudo nano /etc/nginx/sites-available/default
```
We will make the following changes to this file:  
 - Add index.php to the index list.  
 - Uncomment the PHP scripts to FastCGI entry block.  
 - Uncomment the line to include snippets/fastcgi-php.conf.  
 - Uncomment the line to enable the fastcgi_pass and the php8.1-fpm. sock.  
 - Uncomment the section to deny all access to Apache .htaccess files.  
 - Uncomment the section to deny access to any file that starts with a dot.

After making these changes, the file should look mostly like this:
```nginx
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    # SSL configuration
    #
    # listen 443 ssl default_server;
    # listen [::]:443 ssl default_server;
    #
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332
    #
    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782
    #
    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    #
    # include snippets/snakeoil.conf;
    root /var/www/html;
    # Add index.php to the list if you are using PHP
    index index.php index.html index.htm index.nginx-debian.html;
    server_name _;
    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        try_files $uri $uri/ =404;
    }
    # pass PHP scripts to FastCGI server
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        # With php-fpm (or other unix sockets):
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        # With php-cgi (or other tcp sockets):
        #fastcgi_pass 127.0.0.1:9000;
    }
    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    location ~ /\.ht {
        deny all;
    }
    # deny acces to every file starting with a dot
    # this is to not expose your .env file accidentally
    location ~ /\.(.*) {
        deny all;
    }
}
```
After making these changes, you can save and close the file. To apply the changes, you must restart Nginx:
```bash
sudo systemctl restart nginx
```

### Testing
PHP should be fully funtional by now. This can be tested by creating a simple PHP file in the web root directory. If for any reason you do not have write permissions to the nginx folder (`/var/www/html`), you can change the permissions to allow this:
```bash
sudo chmod -R 777 /var/www/html
```
After changing the permissions, you can create a simple PHP file:
```bash
echo "<?php phpinfo(); ?>" >> /var/www/html/info.php
```
And when you visit the page `http://your_domain_or_IP/info.php` you should see the PHP information page.  
If this page shows up, PHP is fully functional and you can move on to the next step.

## MySQL
### Installing MySQL
Installing MySQL is as simple as running the following command:
```bash
sudo apt install mysql-server
```
Wich after installing, you can again verify that it is running by checking the status:
```bash
sudo systemctl status mysql
```

### Setting up MySQL
After installing MySQL, it is recomended to run the security script that is included with MySQL:
```bash
sudo mysql_secure_installation
```
Now go through the script and answer the questions.
Afterwards you should be able to login using the root user:
```bash
sudo mysql -u root -p
```
And as password you can use the password you set during the security script or if you didn't set one, use the password of the sudo user.

Now we should set up an account for the application to use:
```sql
CREATE USER 'username'@'localhost' IDENTIFIED BY 'password';
```
Where you should replace `username` with the username you want to use and `password` with the password you want to use.  
After creating the user, we should give it the required permissions:
```sql
GRANT ALL PRIVILEGES ON *.* TO 'username'@'localhost' WITH GRANT OPTION;
```
Where you should replace `username` with the username you want to use.  
To save the new settings, you should run the following command:
```sql
FLUSH PRIVILEGES;
```
And then you can exit the MySQL shell with following command:
```sql
exit;
```
You can now test your new user by logging in.  
The database should now be set up and ready to use. Continue to the next step to set up the application.

## .env
The .env file is the configuration file for the application. As we will now be using a secured database we should add the database credentials to the .env file. If a mail system is also set up this would be the time to add the mail credentials to the .env file as well.  
Firstly go to your code map and then copy the .env.example file to .env using the following command:
```bash
cp .env.example .env
```
Now open the .env file in the text editor of your choice and edit to match the following lines:
```env
# Application settings
APP_NAME=KGK-001-Plattegrondsysteem # The name of your application - should be correcy by default
APP_ENV=production
APP_KEY=base64:your_app_key # the app key in base64 format
APP_DEBUG=false
APP_URL=https://your_domain_or_IP # The domain or IP address of your server

LOG_CHANNEL=stack
LOG_DEPRECATIONS_CHANNEL=stack
LOG_LEVEL=error

# Database settings
DB_CONNECTION=mysql # Change if using other db engine
DB_HOST=127.0.0.1 # Or the IP address of your MySQL server if it is not on the same server
DB_PORT=3306
DB_DATABASE=kgk001
DB_USERNAME=username # The username you set up in the MySQL step
DB_PASSWORD=password # The password you set up in the MySQL step

BROADCAST_DRIVER=log
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
SESSION_LIFETIME=120

MEMCACHED_HOST=127.0.0.1

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

# Mail settings
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com # Or the mail host you are using
MAIL_PORT=465
MAIL_USERNAME=email@gmail.com # The email address of the email account
MAIL_PASSWORD=password # The password or token of the email account
MAIL_ENCRYPTION=ssl
MAIL_FROM_ADDRESS=email@gmail.com # Should be the same as the MAIL_USERNAME
MAIL_FROM_NAME="Plattegrond app" # The name that should be displayed as the sender
```

## Application
### Changing nginx root
To change the nginx root to the public folder of the application, you should open the default nginx configuration file:
```bash
sudo nano /etc/nginx/sites-available/default
```
And change the root to the public folder of the application:
```nginx
root /var/www/{your_location};
```
And restart nginx:
```bash
sudo systemctl restart nginx
```
### Installing Npm & Dependencies
Install npm:
```bash
sudo apt install npm
```
Install dependencies:
```bash
npm install
```
#### Node.js

Download and import the Nodesource GPG key
```bash
sudo apt update
sudo apt install -y ca-certificates curl gnupg
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
```

Create deb repository
```bash
echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | sudo tee /etc/apt/sources.list.d/nodesource.list
```

Run Update and Install
```bash
sudo apt update
sudo apt install nodejs -y
```

If it gives a dpkg error, run the following commands:
```bash
sudo dpkg --remove --force-remove-reinstreq libnode-dev
sudo dpkg --remove --force-remove-reinstreq libnode72:amd64
```

### Installing Composer & Dependencies
To install composer, you should run the following commands:
```bash
sudo apt install composer
```
Because we use extensions in php we will have to install these:
```bash
sudo apt install php-xml php-gd php-curl php-zip php-mysql php-redis
```
After installing composer, you can install the dependencies:
```bash
composer install --no-dev --optimize-autoloader
composer update --no-dev --optimize-autoloader
```
If this does not work, try sudo.

Install redis:
```bash
sudo apt install redis-server
sudo systemctl restart nginx
composer require predis/predis
```
> note: When using combell, enable redis in the control panel under performance and caching, then add your credentials to the .env file

### Artisan
To set up the application, you should run the following commands:
```bash
php artisan migrate
php artisan db:seed
php artisan config:clear
php artisan config:cache
php artisan queue:restart
```
If this does not work, try sudo.

During deployment, the user of www was changed to root, so if this happened to you as well you can revert this by executing the following command:
```bash
sudo chown -R www-data:www-data /var/www
```

### build
To build the application, you should run the following commands:
```bash
npm run build
```

## Scripts
### First setup
To set up the automatic updates using the script, you should firstly change all the variables in the script to match your server. Note that the download variable is set up for the dev environment in the included bash files.
After changing the variables, you should run the `git-autopull-initial-setup.sh` script (after adding it to the server) using the following command:
```bash
bash git-autopull-initial-setup.sh
```
This will set up the server for the automatic update script. When you want to update the application from now on you can use the `git-autopull.sh` script. These variables should also be changed to match your server. It is recommended to replace the setup script with the update script after the initial setup.

## Finished
### Summary
The application should now be fully functional. You can test this by visiting the domain or IP address of your server.

> note: If the application doesnt behave correctly or you get a 500 error, in our experience we learned that the support of combell is very helpful and can help you fix the problem.  
Further problems can be solved by contacting us.